-- [[
-- added by wsh @ 2017-12-03
-- UI工具类
-- ]]
local UIUtil = {}
local typeText = typeof(CS.UnityEngine.UI.Text)
local typeImage = typeof(CS.UnityEngine.UI.Image)
local typeButton = typeof(CS.UnityEngine.UI.Button)
local typeInput = typeof(CS.UnityEngine.UI.InputField)
local typeSlider = typeof(CS.UnityEngine.UI.Slider)
local typeScrollRect = typeof(CS.UnityEngine.UI.ScrollRect)
local typeToggle = typeof(CS.UnityEngine.UI.Toggle)
local typeUIForm = typeof(CS.UnityGameFramework.Runtime.UIForm)
local typeRectTransform = typeof(CS.UnityEngine.RectTransform)
local typeParticleSystem = typeof(CS.UnityEngine.ParticleSystem)
local typeCanvasGroup = typeof(CS.UnityEngine.CanvasGroup)
local emptySprite = nil

function UIUtil.LoadSpriteAtlasSucceed(spriteAtlas)
	emptySprite = spriteAtlas:GetSprite("other_empty_img")
end
CS.Hr.LuaCallStatic.LoadSpriteAtlas("Common/Atlas/atlas_commonother", UIUtil.LoadSpriteAtlasSucceed)

local function GetChild(trans, index)
	return trans:GetChild(index)
end

-- 注意：根节点不能是隐藏状态，否则路径将找不到
local function FindComponent(trans, ctype, path)
	assert(trans ~= nil)
	assert(ctype ~= nil)

	local targetTrans = trans
	if path ~= nil and type(path) == "string" and #path > 0 then
		targetTrans = trans:Find(path)
	end
	if targetTrans == nil then
		return nil
	end
	local cmp = targetTrans:GetComponent(ctype)
	if cmp ~= nil then
		return cmp
	end
	return targetTrans:GetComponentInChildren(ctype)
end

local function FindTrans(trans, path)
	return trans:Find(path)
end

local function FindText(trans, path)
	return FindComponent(trans, typeText, path)
end

local function FindImage(trans, path)
	return FindComponent(trans, typeImage, path)
end

local function FindButton(trans, path)
	return FindComponent(trans, typeButton, path)
end

local function FindInput(trans, path)
	return FindComponent(trans, typeInput, path)
end

local function FindSlider(trans, path)
	return FindComponent(trans, typeSlider, path)
end

local function FindScrollRect(trans, path)
	return FindComponent(trans, typeScrollRect, path)
end

local function FindToggle(trans, path)
	return FindComponent(trans, typeToggle, path)
end

local function FindRectTransform(trans, path)
	return FindComponent(trans, typeRectTransform, path)
end

local function FindUIForm(trans)
	return FindComponent(trans, typeUIForm, "")
end

local function FindParticleSystem(trans, path)
	return FindComponent(trans, typeParticleSystem, path)
end

local function FindCanvasGroup(trans, path)
	return FindComponent(trans, typeCanvasGroup, path)
end
-- 获取直属画布
local function GetCanvas(ui_component)
	-- 初始化直属画布
	local canvas = nil
	if ui_component._class_type == UILayer then
		canvas = ui_component
	else
		local now_holder = ui_component.holder
		while now_holder ~= nil do
			local var = ui_component:GetComponents(UICanvas)
			if table.count(var) > 0 then
				assert(table.count(var) == 1)
				canvas = var[1]
				break
			end
			now_holder = now_holder.holder
		end
	end
	assert(canvas ~= nil)
	return canvas
end

local function ConcatTable(t1, t2)
	local concat = {}
	local len = #t1
	for i = 1, len do
		concat[i] = t1[i]
	end
	for i = 1, #t2 do
		concat[len + i] = t2[i]
	end
	return concat
end

-- 绑定函数
local function Bind(func, obj, ...)
	local parms = {...}
	return function(...)
		local par = {...}
		if obj ~= nil then
			func(obj, table.unpack(ConcatTable(parms, par)))
		else
			func(table.unpack(ConcatTable(parms, par)))
		end
	end
end

-- 获得图集函数
local function GetSprite(atlas, spritename)
	local sprite = emptySprite
	if atlas ~= nil then
		sprite = atlas:GetSprite(spritename)
		if sprite == nil then
			sprite = emptySprite
			Logger.Log("Sprite " .. spritename .. "not exist!")
		end
	else
		Logger.Log("Sprite atlas not exist!")
	end
	return sprite
end

function UIUtil.MTClassToArrByKey(mt, arr, key)
	local table = table
	local a, b = mt[key .. "Length"](mt)
	for i = 1, mt[key .. "Length"](mt) do
		local t = mt[key](mt, i)
		table.insert(arr, t)
	end
end

UIUtil.GetChild = GetChild
UIUtil.FindComponent = FindComponent
UIUtil.FindTrans = FindTrans
UIUtil.FindText = FindText
UIUtil.FindImage = FindImage
UIUtil.FindButton = FindButton
UIUtil.FindInput = FindInput
UIUtil.FindSlider = FindSlider
UIUtil.FindScrollRect = FindScrollRect
UIUtil.FindUIForm = FindUIForm
UIUtil.Bind = Bind
UIUtil.FindToggle = FindToggle
UIUtil.FindRectTransform = FindRectTransform
UIUtil.GetSprite = GetSprite
UIUtil.FindParticleSystem = FindParticleSystem
UIUtil.FindCanvasGroup = FindCanvasGroup
return UIUtil
